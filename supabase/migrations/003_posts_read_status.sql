-- Таблица для отслеживания прочитанных постов
CREATE TABLE post_reads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  post_id UUID REFERENCES posts(id) ON DELETE CASCADE NOT NULL,
  read_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, post_id)
);

CREATE INDEX idx_post_reads_user ON post_reads(user_id, read_at DESC);

-- RLS для post_reads
ALTER TABLE post_reads ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own read status" ON post_reads
  FOR SELECT USING (auth.uid()::text = (SELECT sso_uid FROM users WHERE id = user_id));

CREATE POLICY "Users can mark posts as read" ON post_reads
  FOR INSERT WITH CHECK (auth.uid()::text = (SELECT sso_uid FROM users WHERE id = user_id));

-- RLS для posts - все могут читать опубликованные посты
ALTER TABLE posts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view published posts" ON posts
  FOR SELECT USING (published = true);

-- Тестовая статья
DO $$
DECLARE
  test_post_id UUID;
BEGIN
  -- Создаем тестовый пост
  INSERT INTO posts (
    id,
    title,
    slug,
    post_type,
    content,
    excerpt,
    category,
    tags,
    published,
    published_at
  ) VALUES (
    uuid_generate_v4(),
    'Как справляться с тревогой: 5 простых техник',
    'kak-spravlyatsya-s-trevoghoi-5-prostyh-tehnik',
    'article',
    E'# Как справляться с тревогой: 5 простых техник\n\nТревога - это естественная реакция нашего организма на стресс. Однако когда она становится чрезмерной, важно знать, как с ней справиться.\n\n## 1. Техника глубокого дыхания\n\nГлубокое дыхание помогает активировать парасимпатическую нервную систему, что способствует расслаблению. Попробуйте дышать по схеме 4-7-8: вдох на 4 счета, задержка на 7, выдох на 8.\n\n## 2. Практика осознанности\n\nОсознанность помогает вернуться в настоящий момент. Когда вы чувствуете тревогу, обратите внимание на пять вещей, которые вы видите, четыре вещи, которые можете потрогать, три звука, два запаха и один вкус.\n\n## 3. Физическая активность\n\nДаже короткая прогулка может значительно снизить уровень тревоги. Движение помогает телу высвободить накопленное напряжение.\n\n## 4. Ведение дневника\n\nЗаписывание своих мыслей и чувств помогает структурировать их и получить новый взгляд на ситуацию. Попробуйте каждый день записывать, что вас беспокоит, и что вы можете с этим сделать.\n\n## 5. Ограничение стимуляторов\n\nКофеин и алкоголь могут усиливать симптомы тревоги. Попробуйте ограничить их потребление, особенно во второй половине дня.\n\n---\n\nПомните, что эти техники - лишь инструменты самопомощи. Если тревога значительно влияет на вашу жизнь, обратитесь к специалисту.',
    'Узнайте о пяти простых и эффективных техниках, которые помогут вам справиться с тревогой в повседневной жизни.',
    'Тревога и стресс',
    ARRAY['тревога', 'техники', 'самопомощь', 'дыхание', 'осознанность'],
    true,
    NOW()
  )
  RETURNING id INTO test_post_id;

  -- Создаем еще несколько постов для разнообразия
  INSERT INTO posts (
    title,
    slug,
    post_type,
    content,
    excerpt,
    category,
    tags,
    published,
    published_at
  ) VALUES
  (
    'Почему важно вести дневник эмоций',
    'pochemu-vazhno-vesti-dnevnik-emocii',
    'article',
    E'# Почему важно вести дневник эмоций\n\nДневник эмоций - это мощный инструмент для понимания себя и своего внутреннего мира.\n\n## Преимущества ведения дневника:\n\n1. **Самопознание** - вы начинаете лучше понимать свои эмоциональные паттерны\n2. **Отслеживание триггеров** - можете заметить, что именно вызывает определенные эмоции\n3. **Снижение стресса** - процесс письма помогает выразить и переработать чувства\n4. **Улучшение настроения** - регулярная практика связана с повышением уровня счастья\n\n## Как начать?\n\nНачните с простого: каждый день записывайте, как вы себя чувствуете и что произошло. Со временем вы сможете замечать интересные закономерности.',
    'Откройте для себя силу ведения дневника эмоций и узнайте, как это может изменить вашу жизнь.',
    'Самопознание',
    ARRAY['дневник', 'эмоции', 'самопознание', 'осознанность'],
    true,
    NOW() - INTERVAL '2 days'
  ),
  (
    'Признаки эмоционального выгорания',
    'priznaki-emocionalnogo-vygoraniya',
    'article',
    E'# Признаки эмоционального выгорания\n\nЭмоциональное выгорание - это состояние физического, эмоционального и ментального истощения.\n\n## Основные признаки:\n\n- Постоянная усталость\n- Снижение мотивации\n- Циничное отношение к работе\n- Проблемы с концентрацией\n- Эмоциональная отстраненность\n\n## Что делать?\n\nЕсли вы заметили у себя эти признаки, важно не игнорировать их. Начните с малого: восстановите режим сна, добавьте физическую активность, научитесь говорить "нет".',
    'Узнайте о признаках эмоционального выгорания и что можно сделать, чтобы его предотвратить.',
    'Выгорание',
    ARRAY['выгорание', 'стресс', 'усталость', 'самопомощь'],
    true,
    NOW() - INTERVAL '5 days'
  );
END $$;






