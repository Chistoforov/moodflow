# Очистка сносок Perplexity

## Проблема
Когда Perplexity отправляет ответ, он содержит сноски на источники в виде цифр в квадратных скобках, например:

```
За эти три дня настроение колебалось от очень высокого до резкого спада и частичного 
восстановления, что говорит о нестабильном, «рваном» эмоциональном фоне в начале 
месяца.[6] При этом есть опыт состояний 5/5 и 3/5, то есть психика уже показывает, что 
способна возвращаться из ямы, а не «зависать» в 1/5. Такой рисунок часто говорит о 
влиянии внешних факторов (работа, нагрузка, события), а не о постоянном фоновом 
снижении настроения.[6]
```

## Решение
Добавлена функция `cleanCitations()`, которая автоматически удаляет все сноски из ответов Perplexity.

### Где применяется
1. **`src/lib/integrations/perplexity.ts`**
   - Метод `parseAnalysisResponse()` - для еженедельных отчетов
   - Метод `analyzeMonthlyMood()` - для месячной аналитики
   
2. **`src/app/api/admin/users/[userId]/analytics/generate/route.ts`**
   - Админский роут для генерации аналитики

### Результат
После очистки текст становится чистым:

```
За эти три дня настроение колебалось от очень высокого до резкого спада и частичного 
восстановления, что говорит о нестабильном, «рваном» эмоциональном фоне в начале 
месяца. При этом есть опыт состояний 5/5 и 3/5, то есть психика уже показывает, что 
способна возвращаться из ямы, а не «зависать» в 1/5. Такой рисунок часто говорит о 
влиянии внешних факторов (работа, нагрузка, события), а не о постоянном фоновом 
снижении настроения.
```

## Технические детали

### Регулярное выражение
```typescript
/\[\d+\]/g
```
- `\[` - открывающая квадратная скобка (экранирована)
- `\d+` - одна или несколько цифр
- `\]` - закрывающая квадратная скобка (экранирована)
- `g` - глобальный флаг (заменяет все вхождения)

### Примеры удаляемых сносок
- `[1]`
- `[6]`
- `[10]`
- `[123]`
- `[999]`

## Автоматическое применение
Очистка применяется автоматически ко всем ответам от Perplexity:
- ✅ Еженедельные отчеты
- ✅ Месячная аналитика
- ✅ Админская генерация аналитики
- ✅ Крон-задачи (monthly-analytics, weekly-summaries)

Никаких дополнительных действий не требуется - все ответы от Perplexity теперь автоматически очищаются от сносок.
