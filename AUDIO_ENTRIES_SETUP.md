# Настройка функционала аудиозаписей в календаре

## Что было реализовано

Добавлен функционал для записи и управления аудиозаписями в календаре:

✅ Возможность записать аудио для любого дня
✅ Несколько аудиозаписей на один день без ограничений
✅ Автоматическая расшифровка через Perplexity API
✅ Удаление аудиозаписей
✅ Отображение статуса расшифровки
✅ Проигрывание аудио прямо в интерфейсе

## Архитектура

### База данных
- **Новая таблица**: `audio_entries` — для хранения множественных аудиозаписей
- Каждая запись содержит: URL аудио, расшифровку, статус обработки, длительность
- Soft delete для безопасного удаления

### API Endpoints
- `GET /api/audio-entries?date=YYYY-MM-DD` — получить все записи для даты
- `POST /api/audio-entries` — загрузить новую аудиозапись
- `DELETE /api/audio-entries?id=UUID` — удалить запись
- `POST /api/transcribe` — расшифровка (обновлено для работы с audio_entries)

### Компоненты
- `AudioRecorder` — компонент для записи аудио (уже существовал)
- `AudioEntriesList` — список всех аудио на конкретную дату
- `AudioModal` — модальное окно для управления аудиозаписями
- Обновленный календарь с кнопками микрофона на каждом дне

## Инструкции по развертыванию

### 1. Запустить миграцию базы данных

```bash
cd moodflow

# Если используете локальный Supabase
npx supabase migration up

# Или выполните миграцию через Supabase Dashboard:
# Скопируйте содержимое файла:
# supabase/migrations/007_create_audio_entries_table.sql
# И запустите в SQL Editor
```

### 2. Проверить Storage bucket

Убедитесь, что bucket `audio-entries` существует в Supabase Storage:

1. Откройте Supabase Dashboard → Storage
2. Bucket `audio-entries` должен быть создан миграцией `006_create_audio_storage_bucket.sql`
3. Проверьте политики доступа (RLS должен быть включен)

### 3. Установить зависимости (если нужно)

```bash
npm install
```

### 4. Запустить проект

```bash
npm run dev
```

## Как использовать

### Для пользователей:

1. **Открыть календарь** — перейти на страницу календаря
2. **Нажать на иконку микрофона** на любом дне
3. **Записать аудио**:
   - Нажать "Записать аудио"
   - Говорить (нет ограничений по длительности)
   - Можно ставить на паузу
   - Завершить запись
4. **Просмотреть записи**:
   - Все записи отображаются в модальном окне
   - Автоматическая расшифровка через несколько секунд
   - Можно прослушать или удалить любую запись
5. **Сделать несколько записей** в один день без ограничений

### Технические детали:

- **Формат аудио**: WebM/Opus (поддерживается всеми современными браузерами)
- **Хранилище**: Supabase Storage bucket `audio-entries`
- **Расшифровка**: Автоматически через Perplexity API в фоне
- **Обновление статуса**: Каждые 5 секунд (polling)

## Настройка Perplexity API

Убедитесь, что у вас настроен Perplexity API для расшифровки:

```env
PERPLEXITY_API_KEY=your_api_key_here
```

Проверьте файл: `src/lib/integrations/perplexity.ts`

## Структура файлов

```
moodflow/
├── supabase/
│   └── migrations/
│       └── 007_create_audio_entries_table.sql  # Новая миграция
├── src/
│   ├── app/
│   │   ├── api/
│   │   │   ├── audio-entries/
│   │   │   │   └── route.ts                    # Новый API endpoint
│   │   │   └── transcribe/
│   │   │       └── route.ts                    # Обновлен
│   │   └── (user)/
│   │       └── calendar/
│   │           └── page.tsx                    # Обновлен
│   ├── components/
│   │   └── entry/
│   │       ├── AudioRecorder.tsx               # Существующий
│   │       ├── AudioEntriesList.tsx            # Новый
│   │       └── AudioModal.tsx                  # Новый
│   └── types/
│       └── database.ts                         # Обновлен (добавлен audio_entries)
```

## Troubleshooting

### Проблема: Аудио не загружается
- Проверьте права доступа к микрофону в браузере
- Убедитесь, что сайт работает через HTTPS (для production)

### Проблема: Расшифровка не работает
- Проверьте PERPLEXITY_API_KEY в переменных окружения
- Проверьте логи API: `/api/transcribe`

### Проблема: Ошибка при загрузке
- Проверьте bucket `audio-entries` в Supabase Storage
- Проверьте RLS политики для таблицы `audio_entries`

### Проблема: Не видно аудиозаписей
- Откройте консоль браузера и проверьте ошибки API
- Проверьте, что миграция успешно выполнена

## Следующие шаги (опционально)

Возможные улучшения:

- [ ] Добавить визуализацию waveform при записи
- [ ] Сжатие аудио перед загрузкой
- [ ] Экспорт всех записей за период
- [ ] Поиск по расшифровкам
- [ ] Голосовые заметки с тегами
- [ ] Интеграция с weekly summaries

## Поддержка

Если возникли вопросы или проблемы, проверьте логи:
- Browser Console (F12)
- Supabase Logs (Dashboard → Database → Logs)
- Server logs (npm run dev output)
