# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "new row violates row-level security policy"

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞ **"new row violates row-level security policy"**. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∞ RLS (Row Level Security) –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –≤—Å—Ç–∞–≤–∫–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

## –ü—Ä–∏—á–∏–Ω–∞

–ü–æ–ª–∏—Ç–∏–∫–∞ RLS –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `daily_entries` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥–∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ `users`, –∫–æ—Ç–æ—Ä–∞—è —Ç–∞–∫–∂–µ –∑–∞—â–∏—â–µ–Ω–∞ RLS. –≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.

## –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ SQL Editor

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://supabase.com/dashboard)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
4. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `supabase/migrations/008_fix_daily_entries_rls.sql`
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å SQL-–∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞
6. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor –∏ –Ω–∞–∂–º–∏—Ç–µ **Run** (–∏–ª–∏ `Cmd/Ctrl + Enter`)

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

1. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å (—Ç–µ–∫—Å—Ç –∏–ª–∏ –∞—É–¥–∏–æ)
3. –û—à–∏–±–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è

1. **–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ RLS** –¥–ª—è `daily_entries`
2. **–°–æ–∑–¥–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** `check_user_entry_ownership()`, –∫–æ—Ç–æ—Ä–∞—è:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `SECURITY DEFINER` –¥–ª—è –æ–±—Ö–æ–¥–∞ RLS –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `users`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∑–∞–ø–∏—Å—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
3. **–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ RLS**, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–¢–∞–∫–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥ –≤ `src/app/api/transcribe/route.ts`:
- –¢–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç `auth.users.id` –≤ `users.id` –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `daily_entries`
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∞—É–¥–∏–æ

## –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Vercel Dashboard ‚Üí **Logs**
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ:
   - Supabase Dashboard ‚Üí **Database** ‚Üí **Migrations**
   - –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∏–¥–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `008_fix_daily_entries_rls`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞:
   - Supabase Dashboard ‚Üí **Database** ‚Üí **Functions**
   - –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏—è `check_user_entry_ownership`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–∏—Ç–∏–∫–∏ RLS:
   - Supabase Dashboard ‚Üí **Database** ‚Üí **Tables** ‚Üí `daily_entries` ‚Üí **Policies**
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 4 –ø–æ–ª–∏—Ç–∏–∫–∏, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏—é `check_user_entry_ownership`

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± (–µ—Å–ª–∏ SQL Editor –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

–ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ SQL Editor –∏–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:

1. Supabase Dashboard ‚Üí **Database** ‚Üí **Tables** ‚Üí `daily_entries`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Policies**
3. –£–¥–∞–ª–∏—Ç–µ –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è `daily_entries`
4. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —á–µ—Ä–µ–∑ **Database** ‚Üí **Functions** ‚Üí **New Function**:
   ```sql
   CREATE OR REPLACE FUNCTION public.check_user_entry_ownership(entry_user_id UUID)
   RETURNS BOOLEAN
   LANGUAGE plpgsql
   SECURITY DEFINER
   SET search_path = public
   AS $$
   BEGIN
     RETURN EXISTS (
       SELECT 1 
       FROM public.users 
       WHERE id = entry_user_id 
       AND sso_uid = auth.uid()::text
     );
   END;
   $$;
   ```
5. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ UI, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏—é `check_user_entry_ownership(user_id)`

